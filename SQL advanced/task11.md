Рефлексия

В целом решение:

1. У меня используется LEFT JOIN и не используется WITH. Есть проблемы с пространством имен, так как иногда не хватает кратких сокращений, это решаю через префикс `_` перед именем. В эталонном решении используется создание таблиц, в которых сгруппированы схожие данные. У меня LEFT JOIN, если внутри сделан GROUP BY, то это по ключу, позволяет относительно безопасно, не боясь задвоений строк, наращивать решение.    

Далее разберу получаемые поля, по которым были сложности.

2. num_craftsdwarves — как и в решении, считаю количество уникальных dwarf_id в таблице WORKSHOP_CRAFTSDWARVES. В эталонном решении используется DISTINCT, как минимум, поскольку соединяется множество таблиц через левое соединение, и, соответственно, если считать без DISTINCT, будет большее количество. У меня, поскольку не уверен, что гном не может быть на двух ролях.
    
3. total_quantity_produced — и в эталонном решении, и у меня считается сумма quantity в таблице WORKSHOP_PRODUCTS. В эталонном решении используется множественный LEFT JOIN, соответственно, может быть «задвоение» сумм, и итоговая сумма будет неверной.    

Например, образовалось несколько строк из workshops с одним workshop_id, после того как соединили с workshop_craftsdwarves, и далее к этой таблице присоединяем workshop_products, откуда берем суммы, применяем агрегатную функцию к этой таблице, и в итоге сумма будет неверной.

4. total_production_value — и в эталонном решении, и у меня считается через произведение value из таблицы PRODUCTS на quantity из таблицы WORKSHOP_PRODUCTS.
    
5. daily_production_rate — в эталонном считается как total_quantity_produced, деленное на время работы, у меня total_production_value на время работы. Причина расхождения — не вполне было понятно, что это за переменная.    

Время работы в эталонном решении находится как время начала работы минус время окончания работы. Время начала работы считается как время первого назначения гнома, поле assignment_date в таблице WORKSHOP_CRAFTSDWARVES. Время окончания считается как время крайнего выпуска продукции, поле production_date в таблице workshop_products.

У меня время начала берётся из поля production_date в таблице WORKSHOP_PRODUCTS, что довольно странно, если оттуда беру количество выпущенной продукции. Время окончания взял наугад не из того поля.

6. value_per_material_unit — главная сложность у меня была понять, откуда брать материалы. В эталонном решении берётся из quantity в таблице WORKSHOP_MATERIALS, при этом is_input = TRUE.    

Я просто посчитал строки в таблице PRODUCTS, предполагая, что для каждой единицы материала создаётся отдельная строка.

7. workshop_utilization_percent — сколько дней работы уже считается при расчёте daily_production_rate. Количество дней работы считается как количество различных дат production_date в таблице workshop_products. Предполагается, что в каждый день работы выпускается по продукту.    

Не считал.

8. material_conversion_ratio — не догадался, как считать. 

В эталонном решении это отношение материалов с признаком is_input = True к материалам с признаком is_input = False в таблице workshop_materials.

9. average_craftsdwarf_skill — в эталонном решении накладывается на dwarf_skills отбор по category = 'Crafting'. И считается AVG(ds.level).    

У меня нет отбора. Предполагаю, что если бы был доступ до базы данных, то этот отбор бы сделал. Актуальный уровень определяю как MAX. А после от этого беру среднее.

10. skill_quality_correlation — считаю так же, как и в эталонном решении, использую агрегатную функцию CORR.